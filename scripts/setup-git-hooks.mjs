import { chmodSync, existsSync, mkdirSync, writeFileSync } from "node:fs";
import { dirname, join } from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const gitDir = join(__dirname, "..", ".git");

if (!existsSync(gitDir)) {
  console.warn("No .git directory found. Skipping hook setup.");
  process.exit(0);
}

const hooksDir = join(gitDir, "hooks");
if (!existsSync(hooksDir)) {
  mkdirSync(hooksDir, { recursive: true });
}

const hookPath = join(hooksDir, "pre-commit");
const hookScript = `#!/bin/sh
# Auto-generated by scripts/setup-git-hooks.mjs
# Runs a verification build before each commit.

echo "Running project verification (npm run verify)..."
npm run verify
RESULT=$?
if [ $RESULT -ne 0 ]; then
  echo "Commit aborted because verification failed."
  exit $RESULT
fi
`;

writeFileSync(hookPath, hookScript, { mode: 0o755 });
chmodSync(hookPath, 0o755);
console.log("Git pre-commit hook installed: npm run verify will run before each commit.");
